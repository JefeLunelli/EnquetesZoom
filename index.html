<!DOCTYPE html>
<html>

<head>
  <link rel="stylesheet" href="styles/styles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/vfs_fonts.js"></script>
  <script src="scripts/main.js"></script>
</head>

<body>

  <button
    onclick="window.open('https://jworg.zoom.us/account/report/export/livepoll?meetingNumber=82186914295')">BaixarEnquete
  </button>

  <input type="file" id="fileInput">

  <button id="uploadButton">Enviar</button>

  <table id="tabela-participantes"></table>

  <button id="pdfButton">Gerar PDF</button>

  <script>

  // Variável para guardar a altura da página A4 em pontos
    var alturaPagina = mmToPt(287);

    // Função para exibir os participantes na página
    function exibirParticipantes(participantes) {

      document.getElementById('fileInput').style.display = 'none';
      document.getElementById('uploadButton').style.display = 'none';
      document.querySelector('button[onclick^="window.open"]').style.display = 'none';
      document.getElementById('pdfButton').style.display = 'inline-block';

      var tabela = document.getElementById('tabela-participantes');

      // Limpar a tabela
      tabela.innerHTML = '';

      // Cabeçalho da tabela
      var cabecalho = document.createElement('tr');
      cabecalho.appendChild(createCell('th', 'Selecionar', true));
      cabecalho.appendChild(createCell('th', 'Nomes pelo Zoom', true));
      var assistenciaCell = createCell('th', 'Assistência', true);
      assistenciaCell.classList.add('assistencia-col');
      cabecalho.appendChild(assistenciaCell);
      tabela.appendChild(cabecalho);

      // Exibir os participantes
      participantes.forEach(function (participante) {
        var nome = participante[1];
        var assistencia = participante[5];

        // Verificar se o nome e a assistência estão preenchidos corretamente
        if (
          nome &&
          assistencia &&
          nome !== 'User Name' &&
          assistencia !==
          '1.Quantas pessoas estarão assistindo a reunião?' &&
          nome !== 'Tablet Tribuna' &&
          nome !== 'Câmera Tribuna'
        ) {
          var linha = document.createElement('tr');
          if (!assistencia.includes('pessoa')) {
            linha.appendChild(
              createCell(
                'td', '<input type="checkbox" class="participante-checkbox">',
                false
              )
            );
            linha.classList.add('unchecked');
          } else {
            linha.appendChild(
              createCell(
                'td',
                '<input type="checkbox" class="participante-checkbox" checked>',
                false
              )
            );
          }
          linha.appendChild(createCell('td', nome, true)).classList.add('nome-participante');
          if (assistencia.startsWith('Já informei a assistência')) {
            assistencia = 'Já Informou';
          }

          // Adicionar um evento de clique (click) para o nome do participante
          linha.querySelector('.nome-participante').addEventListener('click', function () {
            var checkbox = linha.querySelector('.participante-checkbox');
            checkbox.checked = !checkbox.checked;
            if (checkbox.checked) {
              linha.classList.remove('unchecked');
            } else {
              linha.classList.add('unchecked');
            }
            atualizarNumeroTotalPessoas();
          });

          // Adicionar um evento de clique (click) para a célula de assistência
          var assistenciaCell = createCell('td', assistencia, true);
          assistenciaCell.addEventListener('click', function () {
            criarCampoDeEntrada(this);
          });

          linha.appendChild(assistenciaCell);

          tabela.appendChild(linha);
        }
      });

      var numeroTotalPessoas = calcularNumeroTotalPessoas(participantes);

      var linha = document.createElement('tr');
      linha.appendChild(createCell('td', '', false));

      // Adicionar um id à célula que contém o texto "Assistência total"
      var totalPessoasLabelCell = createCell('td', 'Assistência total', true);
      totalPessoasLabelCell.id = 'total-pessoas-label';
      linha.appendChild(totalPessoasLabelCell);

      var numeroTotalPessoasCell = createCell(
        'td',
        numeroTotalPessoas,
        true
      );
      numeroTotalPessoasCell.id = 'numero-total-pessoas';
      linha.appendChild(numeroTotalPessoasCell);
      tabela.appendChild(linha);

      var checkboxes = document.querySelectorAll('.participante-checkbox');
      checkboxes.forEach(function (checkbox) {
        checkbox.addEventListener('change', function () {
          var row = this.parentNode.parentNode;
          if (this.checked) {
            row.classList.remove('unchecked');
          } else {
            row.classList.add('unchecked');
          }
          atualizarNumeroTotalPessoas();
        });
      });
    }


    // Função para criar uma célula da tabela com um texto
    function createCell(tag, text, escape) {
      var cell = document.createElement(tag);

      if (escape) {
        var textNode = document.createTextNode(text);
        cell.appendChild(textNode);
      } else {
        cell.innerHTML = text;
      }

      return cell;
    }

    function criarCampoDeEntrada(cell) {
      var assistenciaText = cell.textContent.trim();
      var assistenciaValue = parseInt(assistenciaText) || 0;

      // Guardar o valor original do placeholder
      var originalPlaceholder = assistenciaValue.toString();

      // Alterar o placeholder para mostrar o valor atual
      cell.textContent = assistenciaValue.toString();

      var assistenciaInput = document.createElement('input');
      assistenciaInput.type = 'number';
      assistenciaInput.value = '';
      assistenciaInput.min = 0;
      assistenciaInput.classList.add('assistencia-cell-input');

      // Definir o placeholder como o valor original
      assistenciaInput.placeholder = originalPlaceholder;

      // Adicionar um evento keydown ao campo de entrada
      assistenciaInput.addEventListener('keydown', function (event) {
        if (event.key === 'Enter') {
          this.blur(); // Remover o foco do campo de entrada
        }
      });

      // Adicionar um evento blur ao campo de entrada
      assistenciaInput.addEventListener('blur', function () {
        // Adicionar um pequeno atraso antes de ler o valor do campo de entrada
        setTimeout(() => {
          var novoValor = this.value.trim();
          if (novoValor === '') {
            // Se o campo de entrada estiver vazio, usar o placeholder como o novo valor
            novoValor = this.placeholder;
          }
          if (novoValor === '0') {
            cell.textContent = 'Já Informou';
            var checkbox = cell.parentNode.querySelector('.participante-checkbox');
            checkbox.checked = false;
            cell.parentNode.classList.add('unchecked'); // Adiciona a classe unchecked à linha
          } else {
            cell.textContent = novoValor + ' pessoa' + (novoValor === '1' ? '' : 's');
            var checkbox = cell.parentNode.querySelector('.participante-checkbox');
            checkbox.checked = true;
            cell.parentNode.classList.remove('unchecked');
          }
          atualizarNumeroTotalPessoas();
        }, 100);
      });

      // Substituir o texto da célula pelo campo de entrada (input)
      cell.textContent = '';
      cell.appendChild(assistenciaInput);
      assistenciaInput.focus();
    }

    // Função para remover o campo de entrada (input) e restaurar o valor original da célula
    function removerCampoDeEntrada(cell, originalValue) {
      var input = cell.querySelector('input');
      var novoValor = input.value.trim();
      if (novoValor === '') {
        // Se o campo de entrada estiver vazio, usar o placeholder como o novo valor
        novoValor = input.placeholder;
      }
      cell.textContent = novoValor;
      atualizarNumeroTotalPessoas();
    }

    // Função para calcular o número total de pessoas
    function calcularNumeroTotalPessoas(participantes) {
      var numeroTotalPessoas = 0;

      // Obter todas as células da coluna "Assistência"
      var assistenciaCells = document.querySelectorAll('#tabela-participantes td:nth-child(3)');

      // Calcular o número total de pessoas com base nos valores das células da coluna "Assistência"
      assistenciaCells.forEach(function (cell) {
        var assistenciaValue = parseInt(cell.textContent) || 0;
        numeroTotalPessoas += assistenciaValue;
      });

      return numeroTotalPessoas;
    }

    // Função para atualizar o número total de pessoas selecionadas
    function atualizarNumeroTotalPessoas() {
      var participantes = getSelectedParticipantes();
      var numeroTotalPessoasElement = document.getElementById('numero-total-pessoas');
      var numeroTotalPessoas = 0;

      participantes.forEach(function (participante) {
        if (participante.selecionado) {
          var assistencia = parseInt(participante.assistencia) || 0;
          numeroTotalPessoas += assistencia;
        }
      });

      numeroTotalPessoasElement.textContent = numeroTotalPessoas;
    }

    // Adicionar um listener para o botão de upload
    document.getElementById('uploadButton').addEventListener('click', function () {
      var fileInput = document.getElementById('fileInput');

      if (fileInput.files.length > 0) {
        var file = fileInput.files[0];
        var reader = new FileReader();
        reader.onload = function (e) {
          var csvContent = e.target.result;
          var lines = csvContent.split('\n');
          var participantes = [];

          for (var i = 0; i < lines.length; i++) {
            // Usar vírgula como separador ao dividir a linha em células
            var row = lines[i].split(',');
            participantes.push(row);
          }

          exibirParticipantes(participantes);
        };
        reader.readAsText(file);
      }
    });

    // Função para gerar o PDF
    document.getElementById('pdfButton').addEventListener('click', function () {
      var selectedParticipantes = getSelectedParticipantes();

      // Verificar se há participantes selecionados antes de criar o PDF
      if (selectedParticipantes.length > 0) {
        var docDefinition = {
          content: [
            {
              table: {
                widths: selectedParticipantes.length > 33 ? ['50%', '46%'] : ['60%', '36%'], // Altere esta linha para ajustar a largura das colunas
                body: [
                  [{ text: 'Nomes pelo Zoom', style: 'tableHeader' }, { text: 'Assistência', style: 'tableHeader' }],
                  ...selectedParticipantes.map(function (participante) {
                    if (participante.selecionado) {
                      var nome = participante.nome.length > (selectedParticipantes.length >= 25 ? 33 : 24) ? participante.nome.substring(0, (selectedParticipantes.length >= 25 ? 33 : 24)) : participante.nome;
                      var assistencia = participante.assistencia.length > (selectedParticipantes.length >= 25 ? 33 : 24) ? participante.assistencia.substring(0, (selectedParticipantes.length >= 25 ? 33 : 24)) : participante.assistencia;

                      // Verificar se há mais de 22 células
                      if (selectedParticipantes.length > 27) {
                        // Reduzir o tamanho do texto
                        nome = nome.substring(0, 35);
                        assistencia = assistencia.substring(0, 15);
                      }

                      return [{ text: nome, style: 'tableCell' }, { text: assistencia, style: ['tableCell', 'centerAligned'] }];
                    }
                  }).filter(Boolean), // Filtrar valores undefined/null
                  [{ text: 'Assistência Total', style: 'tableHeader' }, { text: document.getElementById('numero-total-pessoas').textContent, style: 'tableHeader' }]
                ]
              },
              layout: {
                fillColor: function (rowIndex, node, columnIndex) {
                  if (rowIndex === 0 || rowIndex === node.table.body.length - 1) {
                    return '#A9A9A9';
                  } else if (rowIndex % 2 !== 0) {
                    return '#C9C9C9';
                  } else {
                    return '#e9e9e9';
                  }
                }
              }
            }
          ],
          styles: {
            tableHeader: {
              fontSize: selectedParticipantes.length >= 33 ? 12 : (selectedParticipantes.length > 22 ? 14 : 20),
              bold: true,
              alignment: 'center'
            },
            tableCell: {
              fontSize: selectedParticipantes.length >= 28 ? 14 : (selectedParticipantes.length > 22 ? 16 : 22),
              alignment: 'center'
            },
            // Adicionar um estilo para o alinhamento à esquerda
            leftAligned: {
              alignment: 'left'
            }
          }
        };

        var numParticipantes = selectedParticipantes.length;
        var alturaLinha = calcularAlturaLinha();

        // Verificar se há mais de 24 células
        if (numParticipantes > 24) {
          // Calcular a altura necessária para exibir todas as células
          var alturaNecessaria = alturaLinha * numParticipantes;

          // Aumentar verticalmente o tamanho da folha se necessário
          if (alturaNecessaria > alturaPagina) {
            docDefinition.pageSize = { width: mmToPt(210), height: mmToPt(297) + alturaNecessaria };
          }
        }

        // Formatar a data atual como dd/mm/yy
        var dataAtual = new Date();
        var dia = dataAtual.getDate().toString().padStart(2, '0');
        var mes = (dataAtual.getMonth() + 1).toString().padStart(2, '0');
        var ano = dataAtual.getFullYear().toString().substring(2);
        var dataFormatada = dia + '/' + mes + '/' + ano;

        pdfMake.createPdf(docDefinition).download(dataFormatada + '.pdf'); // Nome do arquivo atualizado
      } else {
        console.log("Nenhum participante selecionado. O PDF não será gerado.");
      }
    });

    // Função para obter os participantes selecionados
    function getSelectedParticipantes() {
      var checkboxes = document.querySelectorAll('.participante-checkbox');
      var selectedParticipantes = [];

      for (var i = 0; i < checkboxes.length; i++) {
        var checkbox = checkboxes[i];
        var row = checkbox.parentNode.parentNode;
        var nome = row.cells[1].textContent;
        var assistencia = row.cells[2].textContent;
        var selecionado = checkbox.checked;

        selectedParticipantes.push({
          nome: nome,
          assistencia: assistencia,
          selecionado: selecionado
        });
      }

      return selectedParticipantes;
    }

    // Função para calcular a altura da linha baseada no número de participantes selecionados
    function calcularAlturaLinha() {
      // Pegar o número de participantes selecionados
      var numParticipantes = getSelectedParticipantes().length;

      // Pegar as margens da página em pontos
      var margemSuperior = 60;
      var margemInferior = 60;

      // Pegar a altura do cabeçalho da tabela em pontos
      var alturaCabecalho = 14;

      // Calcular a altura disponível para a tabela
      var alturaTabela = alturaPagina - margemSuperior - margemInferior - alturaCabecalho;

      // Calcular a altura ideal para cada linha
      var alturaLinha = alturaTabela / (numParticipantes + 2); // +1 para contar a linha de assistência total

      // Aumentar a altura da linha se houver até 24 células
      if (numParticipantes <= 24) {
        alturaLinha += 2;
      }

      // Garantir que a altura da linha não seja menor que a altura da fonte
      var alturaFonte = 12;
      if (alturaLinha < alturaFonte) {
        alturaLinha = alturaFonte;
      }

      return alturaLinha;
    }
  </script>
</body>

</html>